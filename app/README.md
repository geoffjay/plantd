[![Go Report Card](https://goreportcard.com/badge/github.com/geoffjay/plantd/app)](https://goreportcard.com/report/github.com/geoffjay/plantd/app)

---

# üåê Plantd Web Application

The web application provides a modern, browser-based interface for monitoring and controlling plantd distributed control system services. Built with Go Fiber and featuring a responsive UI, it serves as the primary dashboard for system administrators and operators.

## Features

- **Service Monitoring**: Real-time status and health monitoring of all plantd services
- **Configuration Management**: Web-based configuration interface for system settings
- **Secure Access**: HTTPS with automatic self-signed certificate generation for development
- **Session Management**: Secure user sessions with configurable storage
- **API Documentation**: Built-in Swagger documentation for REST endpoints
- **Responsive Design**: Modern UI that works on desktop and mobile devices
- **Real-time Updates**: Server-Sent Events (SSE) for live dashboard updates

## Quick Start

### Prerequisites

- Go 1.24 or later
- Node.js (for frontend asset compilation)

### Development Setup

1. **Build and run the application**:
   ```bash
   cd app
   go run main.go
   ```

2. **Access the web interface**:
   - **HTTPS (Default)**: `https://localhost:8443`
   - **HTTP (Optional)**: `http://localhost:8080` (see HTTP Mode section)

## SSL/HTTPS Configuration

### üîê HTTPS Mode (Default & Recommended)

The app runs in HTTPS mode by default for security and to match production environments.

**Default Configuration:**
- **URL**: `https://localhost:8443`
- **Certificate**: Auto-generated self-signed certificate
- **Validity**: 1 year from generation
- **SAN Entries**: `localhost`, `*.localhost`, `127.0.0.1`, `::1`

**First-Time Setup:**
1. Start the app service: `overmind start app` or `go run main.go`
2. Open `https://localhost:8443` in your browser
3. **Accept the security warning** for the self-signed certificate:
   - Click "Advanced" or "Show Details"
   - Click "Proceed to localhost (unsafe)" or "Accept Risk and Continue"
4. ‚úÖ **The certificate is safe** - it's generated by plantd for development

**Certificate Details:**
```bash
# View certificate information
openssl x509 -in cert/app-cert.pem -text -noout | grep -A 5 "Subject Alternative Name"

# Test HTTPS connection
curl -k https://localhost:8443/
```

### üåê HTTP Mode (Development Alternative)

For development scenarios where HTTPS isn't required, you can run in HTTP mode.

**Enable HTTP Mode:**
```bash
# Set environment variable
export PLANTD_APP_USE_HTTP=true

# Restart the service
overmind restart app

# Access via HTTP
open http://localhost:8080
```

**HTTP Mode Features:**
- ‚úÖ **No certificate warnings** in browser
- ‚úÖ **Faster development** without SSL handshake
- ‚úÖ **Simpler debugging** with standard HTTP tools
- ‚ö†Ô∏è **Development only** - automatically disabled in production
- ‚ö†Ô∏è **No encryption** - not suitable for sensitive data

**Disable HTTP Mode:**
```bash
# Remove environment variable
unset PLANTD_APP_USE_HTTP

# Restart the service
overmind restart app

# Back to HTTPS mode
open https://localhost:8443
```

### üõ†Ô∏è Advanced Certificate Options

#### Option 1: Regenerate Self-Signed Certificate
```bash
# Remove existing certificates
rm cert/app-*.pem

# Restart service to regenerate
overmind restart app

# New certificate will be created automatically
```

#### Option 2: Use mkcert for Trusted Certificates
For the best development experience with no browser warnings:

```bash
# Install mkcert
brew install mkcert          # macOS
# or
sudo apt install mkcert      # Ubuntu/Debian
# or
choco install mkcert         # Windows

# Install local CA
mkcert -install

# Generate trusted certificate
mkcert localhost 127.0.0.1 ::1 plantd.local

# Replace app certificates
mv localhost+3.pem cert/app-cert.pem
mv localhost+3-key.pem cert/app-key.pem

# Restart service
overmind restart app

# Now https://localhost:8443 will be trusted! ‚úÖ
```

#### Option 3: Custom Certificate
```bash
# Set custom certificate paths
export PLANTD_APP_TLS_CERT="/path/to/your/cert.pem"
export PLANTD_APP_TLS_KEY="/path/to/your/key.pem"

overmind restart app
```

## Environment Configuration

### Core Settings
```bash
# Server binding
export PLANTD_APP_BIND_ADDRESS="127.0.0.1"  # or "0.0.0.0" for all interfaces
export PLANTD_APP_BIND_PORT="8443"          # HTTPS port (8080 for HTTP mode)

# SSL/TLS Configuration
export PLANTD_APP_USE_HTTP="false"          # Set to "true" for HTTP mode
export PLANTD_APP_TLS_CERT="cert/app-cert.pem"
export PLANTD_APP_TLS_KEY="cert/app-key.pem"

# Development settings
export PLANTD_APP_LOG_LEVEL="debug"         # Enable debug logging
export PLANTD_APP_PUBLIC_PATH="./app/static" # Static files path
```

### Service Integration
```bash
# Identity Service
export PLANTD_IDENTITY_ENDPOINT="tcp://127.0.0.1:7200"

# Broker Service  
export PLANTD_BROKER_ENDPOINT="tcp://127.0.0.1:9797"

# State Service
export PLANTD_STATE_ENDPOINT="tcp://127.0.0.1:7300"
```

## Testing & Troubleshooting

### üß™ SSL/TLS Testing Script

Use the built-in testing script to verify your configuration:

```bash
# Run comprehensive SSL/TLS tests
./scripts/test-ssl

# Test specific modes
./scripts/test-ssl https    # Test HTTPS only
./scripts/test-ssl http     # Test HTTP only
./scripts/test-ssl help     # Show help and troubleshooting
```

### Common Issues

#### 1. Certificate Errors (`ERR_CERT_AUTHORITY_INVALID`)
**Cause**: Self-signed certificate not trusted by browser
**Solutions**:
```bash
# Option A: Accept the certificate in browser (recommended)
# 1. Click "Advanced" in the security warning
# 2. Click "Proceed to localhost (unsafe)"

# Option B: Use HTTP mode for development
export PLANTD_APP_USE_HTTP=true && overmind restart app

# Option C: Use mkcert for trusted certificates (see above)
```

#### 2. SSE Connection Failures
**Cause**: Usually related to certificate issues
**Solutions**:
```bash
# Ensure certificate is accepted in browser first
# Then test SSE endpoints:
curl -k https://localhost:8443/sse
curl -k https://localhost:8443/dashboard/sse
```

#### 3. Port Conflicts
**Cause**: Another service using the same port
**Solutions**:
```bash
# Check what's using the port
lsof -i :8443
lsof -i :8080

# Use different port
export PLANTD_APP_BIND_PORT="9443"
overmind restart app
```

#### 4. Certificate Expired
**Cause**: Self-signed certificate past its validity period
**Solutions**:
```bash
# Check certificate validity
openssl x509 -in cert/app-cert.pem -text -noout | grep "Not After"

# Regenerate certificate
rm cert/app-*.pem && overmind restart app
```

### üîç Debugging Commands

```bash
# Check service status
overmind status

# View app logs
overmind logs app

# Test connections
curl -k -I https://localhost:8443/
curl -I http://localhost:8080/

# Certificate information
openssl x509 -in cert/app-cert.pem -text -noout

# Network connections
lsof -i :8443
lsof -i :8080
```

## Production Deployment

### 1. Use Valid SSL Certificates
```bash
# Never use self-signed certificates in production
# Use certificates from a trusted CA (Let's Encrypt, etc.)
export PLANTD_APP_TLS_CERT="/etc/ssl/certs/plantd.crt"
export PLANTD_APP_TLS_KEY="/etc/ssl/private/plantd.key"
```

### 2. Security Configuration
```bash
# Bind to specific interface
export PLANTD_APP_BIND_ADDRESS="10.0.1.100"

# Use standard HTTPS port
export PLANTD_APP_BIND_PORT="443"

# Disable HTTP mode (default in production)
unset PLANTD_APP_USE_HTTP

# Set production environment
export PLANTD_ENV="production"
```

### 3. Build for Production
```bash
# Build optimized binary
make build-app

# Run with production settings
./build/plantd-app
```

## Architecture

### Directory Structure
```
app/
‚îú‚îÄ‚îÄ config/          # Configuration management
‚îú‚îÄ‚îÄ handlers/        # HTTP request handlers
‚îú‚îÄ‚îÄ internal/        # Internal packages
‚îÇ   ‚îú‚îÄ‚îÄ auth/        # Authentication & authorization
‚îÇ   ‚îú‚îÄ‚îÄ handlers/    # Internal handler implementations
‚îÇ   ‚îú‚îÄ‚îÄ models/      # Data models
‚îÇ   ‚îî‚îÄ‚îÄ services/    # Service integrations
‚îú‚îÄ‚îÄ static/          # Static assets (CSS, JS, images)
‚îú‚îÄ‚îÄ views/           # HTML templates
‚îú‚îÄ‚îÄ cert/            # SSL certificates
‚îî‚îÄ‚îÄ main.go          # Application entry point
```

### Key Components
- **Authentication**: Integration with Identity Service
- **Real-time Updates**: Server-Sent Events (SSE) for live data
- **Service Integration**: MDP protocol communication with plantd services
- **Security**: HTTPS, CSRF protection, session management
- **UI Framework**: Templ templates with Tailwind CSS
- **Asset Pipeline**: Bun for JavaScript/CSS compilation

## Integration

The web application integrates with other plantd services:

- **Identity Service**: User authentication and authorization
- **Broker Service**: Message routing and service discovery
- **State Service**: Distributed state management
- **Health Service**: System health monitoring
- **Metrics Service**: Performance monitoring and alerting

## Contributing

See the main [plantd contributing guide](../README.md#contributing) for development setup and guidelines.

### Development Workflow
1. **Start services**: `overmind start`
2. **Choose your mode**: HTTPS (default) or HTTP (`PLANTD_APP_USE_HTTP=true`)
3. **Accept certificate**: For HTTPS mode, accept the self-signed certificate
4. **Develop**: Make changes and test
5. **Test SSL**: Use `./scripts/test-ssl` to verify configuration

## License

This project is licensed under the MIT License - see the [LICENSE](../LICENSE) file for details. 
